# 實盤觀察筆記 - 緊急止損事件

日期：2025年12月29日
週次：Phase 1 第 1 週

---

## 事件摘要

2025-12-29 00:00 (UTC) 這根 4H K 線，市場急漲導致 4 個 SHORT 倉位觸發緊急止損（3.5x ATR）。

| 幣種 | Breach Ratio | 閾值 | 結果 |
|------|-------------|------|------|
| BTC | 4.63x ATR | 3.5x | 平倉 |
| ETH | 4.01x ATR | 3.5x | 平倉 |
| SOL | 4.26x ATR | 3.5x | 平倉 |
| BNB | 3.74x ATR | 3.5x | 平倉 |
| XRP | 3.13x ATR | 3.5x | 保留（正確行為） |

**結論：止損邏輯運算正確，非誤觸。**

---

## 開倉品質分析

開倉時間約在 12/27，當時均線狀態：

| 幣種 | 均線間距 | ATR 倍數 | 評估 |
|------|---------|---------|------|
| BTC | 0.16% | 0.17x | 間距過小，盤整狀態 |
| ETH | 0.56% | 0.46x | 間距偏小，趨勢弱 |
| SOL | 1.05% | 0.63x | 間距 OK，但 ATR 倍數不足 |

### 觀察

均線排列確實「不夠分離」：
- BTC 只有 0.16% 間距，幾乎是平的
- 當時趨勢判斷條件只看 `avg20 < avg60`，沒有檢查間距

---

## 潛在優化方向（Phase 1 結束後評估）

1. **最小均線間距過濾**
   - 參數：`min_ma_gap_pct: 0.5` 或 `min_ma_gap_atr: 1.0`
   - 效果：過濾盤整期的假信號
   - 風險：可能錯過趨勢起點

2. **ATR 確認**
   - 要求 gap > 2x ATR 才開倉
   - 效果：增加趨勢確認度
   - 風險：減少交易次數

3. **趨勢延續確認**
   - 要求前 N 根 K 線持續同方向
   - 效果：避免震盪假突破

---

## 當前決策

根據 PHASE1_RESTRICTIONS：
> 在震盪期添加過濾條件

**決定：不修改，繼續觀察。**

這次虧損是策略「寬鬆進場」的固有特性，不是 bug。
策略設計接受一定的假信號，換取不錯過真趨勢。

---

## 後續追蹤

- [ ] Phase 1 結束後，統計類似情況發生次數
- [ ] 計算加入均線間距過濾後的回測差異
- [ ] 評估是否值得犧牲部分信號換取更高勝率

---

## 技術修復（已完成）

此次事件同時發現並修復的 bug：

1. **心跳通知 "總計: +$0.00"**
   - 原因：ISOLATED 保證金模式下 `crossUnPnl` 為 0
   - 修復：改為從每個持倉累加 `unrealized_pnl`

2. **平倉通知 "Exit: $0.00, +100%"**
   - 原因：Binance API 對市價單返回 `avgPrice=0`
   - 修復：從 `fills` 陣列計算加權平均價格

3. **止損日誌不足**
   - 新增詳細的 ATR/breach/ratio 日誌

---

*記錄者：Claude Code*
*提交：97ded73*
