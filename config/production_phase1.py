"""
BiGe 7x ç­–ç•¥ - å¯¦ç›¤ç¬¬ä¸€éšæ®µé…ç½®

âš ï¸ æ³¨æ„ï¼šæ­¤é…ç½®ç‚ºä¿å®ˆèµ·æ­¥è¨­å®š
âš ï¸ é€šéç¬¬ä¸€éšæ®µé©—è­‰å¾Œï¼Œæ‰èƒ½å‡ç´šåˆ° phase2 é…ç½®
"""

# =============================================================================
# å¯¦ç›¤ç¬¬ä¸€éšæ®µåƒæ•¸ï¼ˆä¿å®ˆè¨­å®šï¼‰
# =============================================================================

PHASE1_CONFIG = {
    # === äº¤æ˜“å° ===
    "symbols": ["BTCUSDT"],  # ç¬¬ä¸€éšæ®µåªåš BTC
    "timeframe": "4h",
    # === æ§“æ¡¿è¨­å®š ===
    "leverage": 7,  # å›æ¸¬é©—è­‰æœ€ç©©å®šçš„è¨­å®š
    # === å€‰ä½ç®¡ç† ===
    "position_size_pct": 0.10,  # 10% å¸³æˆ¶æ¬Šç›Š
    "add_position_mode": "fixed_50",  # å›ºå®š 50% åŠ å€‰
    "max_add_count": 3,  # æœ€å¤š 3 æ¬¡åŠ å€‰ï¼ˆä¿å®ˆå‹ï¼Œ2é€±å¾Œå¯å‡ç´šï¼‰
    # === è¶¨å‹¢åˆ¤æ–· ===
    "trend_mode": "loose",  # MA20 > MA60 å³å¯åšå¤š
    "ma_fast": 20,
    "ma_slow": 60,
    # === æ­¢æè¨­å®š ===
    "stop_loss_confirm_bars": 10,  # é€£çºŒ 10 æ ¹ K ç·šç¢ºèª
    "ma20_buffer": 0.02,  # 2% ç·©è¡
    # === å›è¸©åŠ å€‰è¨­å®š ===
    "pullback_tolerance": 0.018,  # 1.8% å®¹è¨±ç¯„åœ
    # === äº¤æ˜“æˆæœ¬ ===
    "fee_rate": 0.0004,  # 0.04% æ‰‹çºŒè²»
    "maintenance_margin_rate": 0.005,  # 0.5% ç¶­æŒä¿è­‰é‡‘
    # === é¢¨æ§åƒæ•¸ ===
    "max_position_value_pct": 0.50,  # æœ€å¤§æŒå€‰ä¸è¶…éå¸³æˆ¶ 50%
    "daily_loss_limit_pct": 0.10,  # å–®æ—¥è™§æé™åˆ¶ 10%
}

# =============================================================================
# ç›£æ§è¨­å®š
# =============================================================================

MONITORING_CONFIG = {
    # RDF é–¾å€¼ï¼ˆå¯¦ç›¤æ”¶ç›Š / å›æ¸¬æ”¶ç›Šï¼‰
    "rdf_normal_min": 0.6,
    "rdf_normal_max": 1.0,
    "rdf_warning": 0.4,
    "rdf_stop": 0.3,
    # âš ï¸ RDF è¨ˆç®—è¦å‰‡ï¼ˆæ™‚é–“å°é½Šï¼‰
    # RDF å¿…é ˆæ¯”è¼ƒã€ŒåŒä¸€æ®µæ™‚é–“ã€çš„å›æ¸¬ vs å¯¦ç›¤
    # ä¸æ˜¯æ‹¿æ•´æ®µå›æ¸¬å»æ¯”æŸä¸€å°æ®µå¯¦ç›¤
    "rdf_calculation": "weekly",  # æ¯é€±è¨ˆç®—ä¸€æ¬¡ï¼Œé€±å°é½Š
    "rdf_lookback_days": 7,  # å¾€å›çœ‹ 7 å¤©
    # æœ€å°‘é‹è¡Œè¦æ±‚
    "min_trades": 20,
    "min_days": 28,
    # é€šçŸ¥è¨­å®š
    "notify_on_trade": True,
    "notify_on_error": True,
    "notify_daily_summary": True,
}

# =============================================================================
# å‡ç´šæ¢ä»¶
# =============================================================================

UPGRADE_CONDITIONS = {
    "to_phase2": {
        "min_days": 28,
        "min_trades": 20,
        "rdf_min": 0.6,
        "rdf_max": 1.0,
        "no_critical_errors": True,
    }
}

# =============================================================================
# ç¬¬äºŒéšæ®µé…ç½®ï¼ˆé€šéç¬¬ä¸€éšæ®µå¾Œä½¿ç”¨ï¼‰
# =============================================================================

PHASE2_CONFIG = {
    **PHASE1_CONFIG,  # ç¹¼æ‰¿ç¬¬ä¸€éšæ®µé…ç½®
    # === å‡ç´šåƒæ•¸ ===
    "leverage": 7,  # å‡ç´šåˆ°é©—è­‰æœ€ä½³æ§“æ¡¿
    "max_add_count": 3,  # å‡ç´šåˆ°é©—è­‰æœ€ä½³åŠ å€‰æ¬¡æ•¸
    # === å¯é¸ï¼šåŠ å…¥ ETH ===
    "symbols": ["BTCUSDT", "ETHUSDT"],
}

# =============================================================================
# ç¦æ­¢äº‹é …
# =============================================================================

PHASE1_RESTRICTIONS = """
å¯¦ç›¤ç¬¬ä¸€éšæ®µç¦æ­¢äº‹é …ï¼š

1. âŒ ä¸­é€”èª¿æ•´æ§“æ¡¿æˆ–åŠ å€‰æ¬¡æ•¸
2. âŒ è¿½åŠ å…¶ä»–å¹£ç¨®
3. âŒ å› é€£çºŒè™§æåœæ­¢ç­–ç•¥ï¼ˆé™¤é RDF < 0.3ï¼‰
4. âŒ æ ¹æ“šã€Œæ„Ÿè¦ºã€èª¿æ•´åƒæ•¸
5. âŒ åœ¨éœ‡ç›ªæœŸæ·»åŠ éæ¿¾æ¢ä»¶
6. âŒ æŠŠã€Œé€£è™§ã€ç•¶æˆç•°å¸¸ï¼ˆé€£è™§ 4-6 ç­†æ˜¯æ­£å¸¸äº‹ä»¶ï¼‰

å”¯ä¸€å…è¨±çš„æ“ä½œï¼š
âœ… ç·Šæ€¥åœæ©Ÿï¼ˆé‡åˆ° bug æˆ– API ç•°å¸¸ï¼‰
âœ… å¯«å¯¦ç›¤è§€å¯Ÿç­†è¨˜ï¼ˆä¸æ”¹ç¢¼ã€ä¸æ”¹åƒæ•¸ï¼‰
"""

# =============================================================================
# é€£è™§èªªæ˜ï¼ˆé‡è¦å¿ƒç†å»ºè¨­ï¼‰
# =============================================================================

CONSECUTIVE_LOSS_GUIDE = """
ğŸ”’ é€£è™§ â‰  ç•°å¸¸

ç­–ç•¥çµæ§‹ä¸‹ï¼Œé€£è™§ 4-6 ç­†æ˜¯æ­£å¸¸äº‹ä»¶ã€‚

ä»€éº¼æ˜¯çœŸæ­£çš„ç•°å¸¸ï¼Ÿ
  âŒ é€£è™§æœ¬èº«ï¼ˆä¸æ˜¯ç•°å¸¸ï¼‰
  âœ… é€£è™§æœŸé–“ RDF æ˜é¡¯åé›¢å›æ¸¬å‹æ…‹ï¼ˆé€™æ‰æ˜¯ç•°å¸¸ï¼‰

åˆ¤æ–·æ–¹å¼ï¼š
  1. è¨ˆç®—è©²é€±çš„å›æ¸¬é æœŸæ”¶ç›Š
  2. è¨ˆç®—è©²é€±çš„å¯¦ç›¤å¯¦éš›æ”¶ç›Š
  3. RDF = å¯¦ç›¤ / å›æ¸¬
  4. åªæœ‰ RDF < 0.4 æ‰éœ€è¦è­¦è¦º

è¨˜ä½ï¼šç”¨ RDFï¼Œä¸ç”¨æƒ…ç·’ã€‚
"""

# =============================================================================
# å¯¦ç›¤è§€å¯Ÿç­†è¨˜æ¨¡æ¿
# =============================================================================

OBSERVATION_LOG_TEMPLATE = """
# å¯¦ç›¤è§€å¯Ÿç­†è¨˜

æ—¥æœŸï¼š____å¹´__æœˆ__æ—¥
é€±æ¬¡ï¼šç¬¬__é€±

## æœ¬é€±äº¤æ˜“æ‘˜è¦
- äº¤æ˜“ç­†æ•¸ï¼š__
- å‹/è² ï¼š__/__
- æœ¬é€±æ”¶ç›Šï¼š__%
- ç´¯è¨ˆæ”¶ç›Šï¼š__%

## æœ¬é€± RDF
- å¯¦ç›¤æ”¶ç›Šï¼š$__
- å›æ¸¬åŒæœŸé æœŸï¼š$__
- RDFï¼š__.__(æ­£å¸¸/è­¦æˆ’/ç•°å¸¸)

## è§€å¯Ÿè¨˜éŒ„ï¼ˆåªè¨˜éŒ„ï¼Œä¸è¡Œå‹•ï¼‰

### åŸ·è¡Œé¢
- [ ] æ»‘é»æ¯”é æœŸå¤§ï¼Ÿå…·é«”æƒ…æ³ï¼š
- [ ] é€²å ´æ™‚é–“å»¶é²ï¼Ÿå»¶é²å¤šä¹…ï¼š
- [ ] è¨Šè™Ÿè¢«åƒæ‰ï¼Ÿå“ªå€‹è¨Šè™Ÿï¼š

### å¸‚å ´é¢
- [ ] æœ¬é€±å¸‚å ´ç‹€æ…‹ï¼šè¶¨å‹¢/éœ‡ç›ª/åè½‰
- [ ] èˆ‡å›æ¸¬æœŸé–“çš„å·®ç•°ï¼š

### å¿ƒç†é¢
- [ ] æœ‰æƒ³èª¿æ•´åƒæ•¸çš„è¡å‹•ï¼ŸåŸå› ï¼š
- [ ] æœ‰æƒ³åœæ­¢ç­–ç•¥çš„å¿µé ­ï¼ŸåŸå› ï¼š

## çµè«–
- [ ] ç¹¼çºŒé‹è¡Œ
- [ ] éœ€è¦ä¸‹é€±é‡é»è§€å¯Ÿï¼š

---
âš ï¸ æé†’ï¼šé€™ä»½ç­†è¨˜åªç”¨æ–¼è¨˜éŒ„ï¼Œä¸ç”¨æ–¼èª¿æ•´ä»»ä½•åƒæ•¸
"""

# =============================================================================
# åœæ­¢æ¢ä»¶
# =============================================================================

STOP_CONDITIONS = {
    # è‡ªå‹•åœæ­¢
    "auto_stop": {
        "single_trade_loss_pct": 0.15,  # å–®ç­†è™§æ > 15%
        "daily_loss_pct": 0.20,  # å–®æ—¥è™§æ > 20%
        "consecutive_losses": 10,  # é€£çºŒè™§æ 10 ç­†
    },
    # æ‰‹å‹•è©•ä¼°åœæ­¢
    "manual_review": {
        "rdf_below_threshold_days": 14,  # RDF < 0.4 æŒçºŒ 14 å¤©
        "api_error_count": 5,  # API éŒ¯èª¤ 5 æ¬¡
    },
    # æ°¸ä¹…åœæ­¢
    "permanent_stop": {
        "total_loss_pct": 0.30,  # ç¸½è™§æ > 30%
        "critical_bug": True,  # ç™¼ç¾é‚è¼¯ bug
    },
}


def get_phase1_config():
    """ç²å–ç¬¬ä¸€éšæ®µé…ç½®"""
    return PHASE1_CONFIG.copy()


def get_phase2_config():
    """ç²å–ç¬¬äºŒéšæ®µé…ç½®ï¼ˆéœ€è¦å…ˆé€šéç¬¬ä¸€éšæ®µï¼‰"""
    return PHASE2_CONFIG.copy()


def check_upgrade_conditions(stats: dict) -> tuple[bool, str]:
    """
    æª¢æŸ¥æ˜¯å¦æ»¿è¶³å‡ç´šæ¢ä»¶

    Args:
        stats: åŒ…å« days, trades, rdf, errors çš„çµ±è¨ˆå­—å…¸

    Returns:
        (æ˜¯å¦é€šé, åŸå› èªªæ˜)
    """
    conditions = UPGRADE_CONDITIONS["to_phase2"]

    if stats.get("days", 0) < conditions["min_days"]:
        return False, f"é‹è¡Œå¤©æ•¸ä¸è¶³ï¼š{stats['days']}/{conditions['min_days']}"

    if stats.get("trades", 0) < conditions["min_trades"]:
        return False, f"äº¤æ˜“ç­†æ•¸ä¸è¶³ï¼š{stats['trades']}/{conditions['min_trades']}"

    rdf = stats.get("rdf", 0)
    if rdf < conditions["rdf_min"]:
        return False, f"RDF éä½ï¼š{rdf:.2f} < {conditions['rdf_min']}"

    if rdf > conditions["rdf_max"]:
        return False, f"RDF ç•°å¸¸é«˜ï¼š{rdf:.2f} > {conditions['rdf_max']}ï¼ˆéœ€æª¢æŸ¥ï¼‰"

    if stats.get("critical_errors", 0) > 0:
        return False, f"å­˜åœ¨åš´é‡éŒ¯èª¤ï¼š{stats['critical_errors']} å€‹"

    return True, "âœ… æ»¿è¶³æ‰€æœ‰å‡ç´šæ¢ä»¶"


if __name__ == "__main__":
    print("=" * 60)
    print("BiGe 7x ç­–ç•¥ - å¯¦ç›¤ç¬¬ä¸€éšæ®µé…ç½®")
    print("=" * 60)

    print("\né…ç½®åƒæ•¸ï¼š")
    for key, value in PHASE1_CONFIG.items():
        print(f"  {key}: {value}")

    print("\n" + PHASE1_RESTRICTIONS)
